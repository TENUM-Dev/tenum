name: Release
on:
  push:
    branches:
      - main

jobs:
  release:
    outputs:
      released: ${{ steps.detect_release.outputs.released }}
      tag: ${{ steps.detect_release.outputs.tag }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      DEPENDABOT_TOKEN: ${{ secrets.DEPENDABOT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ env.DEPENDABOT_TOKEN }}
      - name: Detect new release tag
        id: detect_release
        run: |
          PRE="${PREV_TAG:-}"
          POST=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$POST" ]; then
            echo "released=true" >> "$GITHUB_OUTPUT"
            echo "tag=$POST" >> "$GITHUB_OUTPUT"
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi
  publish-npm:
    name: Publish npm package
    needs:
      - release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.DEPENDABOT_TOKEN }}
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - name: Install npm dependencies
        working-directory: clinpm
        run: npm ci
      - name: Build CLI JS artifacts
        run: ./gradlew :clinpm:installLocal --stacktrace --no-daemon
      - name: Build npm package
        working-directory: clinpm
        run: npm run build:bundle:install

      - name: Select release tag
        id: choose_tag
        run: |
          if [ "${{ needs.release.outputs.released }}" = "true" ]; then
            echo "tag=${{ needs.release.outputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no release tag
        if: steps.choose_tag.outputs.tag == ''
        run: echo "No release produced, skipping npm publish."

      - name: Prepare npm package
        if: steps.choose_tag.outputs.tag != ''
        id: prepare_package
        working-directory: clinpm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ steps.choose_tag.outputs.tag }}"
          VERSION="${TAG#v}"

          PUBLISHED=$(npm view @luak2/cli version 2>/dev/null || echo "")

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "skip_publish=false" >> "$GITHUB_OUTPUT"

          if [ "$VERSION" = "$PUBLISHED" ]; then
            echo "Version $VERSION already published, skipping."
            echo "skip_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          npm version --no-git-tag-version "$VERSION"
          TARBALL=$(npm pack | tail -n1)
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "tarball_path=$(pwd)/$TARBALL" >> "$GITHUB_OUTPUT"

      - name: Upload npm package to GitHub release
        if: steps.choose_tag.outputs.tag != '' && steps.prepare_package.outputs.skip_publish != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.choose_tag.outputs.tag }}
          files: ${{ steps.prepare_package.outputs.tarball_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to npm
        if: steps.choose_tag.outputs.tag != '' && steps.prepare_package.outputs.skip_publish != 'true'
        working-directory: clinpm
        run: npm publish --access public
  sync-dev-pr:
    name: Sync dev PR
    needs:
      - release
      - publish-npm
    if: needs.release.outputs.released == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      BOT_TOKEN: ${{ secrets.DEPENDABOT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ env.BOT_TOKEN }}

      - name: Check for changes from main to dev
        id: diff
        run: |
          git fetch origin main dev --prune
          if git diff --quiet origin/dev..origin/main; then
            echo "has_diff=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_diff=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or reuse sync PR
        id: pr
        if: steps.diff.outputs.has_diff == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
            const head = "main";
            const base = "dev";
            const title = "Sync: main -> dev";
            const body = "Automated sync PR from main to dev.";

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: `${owner}:${head}`,
              base,
              per_page: 1
            });

            let pr = existing.data[0];
            if (!pr) {
              pr = (await github.rest.pulls.create({ owner, repo, head, base, title, body })).data;
            }

            core.setOutput("number", pr.number.toString());
            core.setOutput("node_id", pr.node_id);

      - name: Approve PR
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ env.BOT_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: "APPROVE",
              body: "Automated approval for sync PR"
            });
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}

      - name: Enable auto-merge
        if: steps.pr.outputs.node_id != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ env.BOT_TOKEN }}
          script: |
            const prNodeId = process.env.PR_ID;
            await github.graphql(
              `
              mutation($prId: ID!) {
                enablePullRequestAutoMerge(input: { pullRequestId: $prId, mergeMethod: SQUASH }) {
                  clientMutationId
                }
              }
              `,
              { prId: prNodeId }
            );
        env:
          PR_ID: ${{ steps.pr.outputs.node_id }}
