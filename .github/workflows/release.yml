name: Release
on:
  push:
    branches:
      - main     # only release when main changes
  workflow_dispatch:
    # allow manual triggering of the release workflow
    inputs: {}
  schedule:
    # Weekly scheduled release check (UTC)
    - cron: '0 3 * * 1'
jobs:
  prepare-release:
    outputs:
      merged: ${{ steps.merge_dev_into_main.outputs.merged }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      - name: Merge dev into main
        id: merge_dev_into_main
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" != "schedule" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "merged=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git fetch origin main dev --prune
          git checkout main
          git pull --ff-only origin main

          if git diff --quiet origin/main origin/dev; then
            echo "merged=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git merge origin/dev --no-edit
          git push origin main
          echo "merged=true" >> "$GITHUB_OUTPUT"
  release:
    needs:
      - prepare-release
    outputs:
      released: ${{ steps.detect_release.outputs.released }}
      tag: ${{ steps.detect_release.outputs.tag }}
    if: github.event_name == 'push' || needs.prepare-release.outputs.merged == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Record previous tag
        run: echo "PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo '')" >> "$GITHUB_ENV"
      - name: semantic-release
        uses: codfish/semantic-release-action@v4
        with:
          additional-packages: |
            ['@semantic-release/changelog', '@semantic-release/git']
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Detect new release tag
        id: detect_release
        run: |
          PRE="${PREV_TAG:-}"
          POST=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$POST" ] && [ "$POST" != "$PRE" ]; then
            echo "released=true" >> "$GITHUB_OUTPUT"
            echo "tag=$POST" >> "$GITHUB_OUTPUT"
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi
  publish-npm:
    name: Publish npm package
    needs:
      - release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - name: Install npm dependencies
        working-directory: clinpm
        run: npm ci
      - name: Build CLI JS artifacts
        run: ./gradlew :clinpm:installLocal --stacktrace --no-daemon
      - name: Build npm package
        working-directory: clinpm
        run: npm run build:bundle:install

      - name: Select release tag
        id: choose_tag
        run: |
          if [ "${{ needs.release.outputs.released }}" = "true" ]; then
            echo "tag=${{ needs.release.outputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no release tag
        if: steps.choose_tag.outputs.tag == ''
        run: echo "No release produced, skipping npm publish."

      - name: Prepare npm package
        if: steps.choose_tag.outputs.tag != ''
        id: prepare_package
        working-directory: clinpm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ steps.choose_tag.outputs.tag }}"
          VERSION="${TAG#v}"

          PUBLISHED=$(npm view @luak2/cli version 2>/dev/null || echo "")

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "skip_publish=false" >> "$GITHUB_OUTPUT"

          if [ "$VERSION" = "$PUBLISHED" ]; then
            echo "Version $VERSION already published, skipping."
            echo "skip_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          npm version --no-git-tag-version "$VERSION"
          TARBALL=$(npm pack | tail -n1)
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "tarball_path=$(pwd)/$TARBALL" >> "$GITHUB_OUTPUT"

      - name: Upload npm package to GitHub release
        if: steps.choose_tag.outputs.tag != '' && steps.prepare_package.outputs.skip_publish != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.choose_tag.outputs.tag }}
          files: ${{ steps.prepare_package.outputs.tarball_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to npm
        if: steps.choose_tag.outputs.tag != '' && steps.prepare_package.outputs.skip_publish != 'true'
        working-directory: clinpm
        env:
          NODE_AUTH_TOKEN: ${ secrets.NPM_TOKEN }
        run: npm publish --access public
  sync-dev:
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Fetch branches
        run: |
          git fetch origin main
          git fetch origin dev
      - name: Update dev from main (fast-forward if possible)
        run: |
          # start from dev
          git checkout dev

          # try fast-forward first (preferred, clean history)
          if git merge --ff-only origin/main; then
            echo "Fast-forwarded dev to main"
          else
            echo "Cannot fast-forward, doing a regular merge"
            git merge origin/main --no-edit
          fi

          # push updated dev back to origin
          git push origin dev
